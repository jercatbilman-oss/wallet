<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîê JERCAT Wallet - Multi-Pages</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            min-height: 100vh;
            padding: 20px;
            color: #e2e8f0;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: linear-gradient(to bottom right, #1e293b, #0f172a);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            border: 1px solid #334155;
        }

        h1 {
            text-align: center;
            background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
            font-size: 32px;
            font-weight: 900;
        }

        .subtitle {
            text-align: center;
            color: #94a3b8;
            margin-bottom: 30px;
            font-size: 14px;
            font-weight: 600;
        }

        /* NAVIGATION */
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #334155;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .nav-tab {
            padding: 12px 20px;
            background: #0f172a;
            border: 2px solid #334155;
            border-radius: 8px 8px 0 0;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 700;
            font-size: 14px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .nav-tab:hover {
            background: #1e293b;
            border-color: #f59e0b;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
            color: #000;
            border-color: #f59e0b;
        }

        /* PAGES */
        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section {
            margin-bottom: 25px;
            padding: 20px;
            background: linear-gradient(to bottom right, #1e293b, #0f172a);
            border-radius: 12px;
            border: 1px solid #334155;
        }

        .section h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #f59e0b;
            font-weight: 700;
        }

        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
            color: #000;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(245, 158, 11, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button.danger {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
        }

        button.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        button.secondary {
            background: #334155;
            color: #e2e8f0;
        }

        input, select {
            width: 100%;
            padding: 12px;
            background: #0f172a;
            border: 2px solid #334155;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 10px;
            color: #e2e8f0;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #f59e0b;
        }

        .warning {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #78350f;
            font-weight: 600;
        }

        .info-box {
            background: #0f172a;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            word-break: break-all;
            font-size: 14px;
            border: 2px solid #334155;
        }

        .info-box label {
            font-weight: 700;
            color: #f59e0b;
            display: block;
            margin-bottom: 8px;
        }

        .hidden { display: none; }

        .balance {
            font-size: 36px;
            font-weight: 900;
            background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
            margin: 20px 0;
        }

        .token-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .token-card {
            position: relative;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 2px solid #334155;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: all 0.2s;
        }

        .token-card:hover {
            border-color: #f59e0b;
            transform: translateY(-2px);
        }

        .log-entry {
            background: #0f172a;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid #f59e0b;
            font-size: 13px;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
            margin-left: 10px;
        }

        .badge-success { background: #10b981; color: white; }
        .badge-warning { background: #f59e0b; color: white; }
        .badge-info { background: #0088cc; color: white; }

        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .stat-box {
            background: #0f172a;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #334155;
        }

        .stat-label {
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 900;
            color: #f59e0b;
        }

        .error { background: linear-gradient(135deg, #fecaca 0%, #fca5a5 100%); border: 2px solid #dc2626; padding: 15px; border-radius: 8px; margin-top: 15px; color: #7f1d1d; font-weight: 600; }
        .success-msg { background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border: 2px solid #10b981; padding: 15px; border-radius: 8px; margin-top: 15px; color: #064e3b; font-weight: 600; }

        .safety-indicator {
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            font-weight: 600;
            border: 2px solid;
        }

        .safety-safe {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border-color: #10b981;
            color: #064e3b;
        }

        .safety-warning {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-color: #f59e0b;
            color: #78350f;
        }

        .safety-danger {
            background: linear-gradient(135deg, #fecaca 0%, #fca5a5 100%);
            border-color: #dc2626;
            color: #7f1d1d;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ JERCAT Wallet</h1>
        <p class="subtitle">Secure Multi-Page Wallet</p>

        <!-- √âcran de connexion -->
        <div id="loginScreen">
            <div class="section">
                <h2>üîì Connexion</h2>
                <input type="password" id="loginPassword" placeholder="Mot de passe">
                <button onclick="login()">D√©verrouiller</button>
                <button onclick="showCreateScreen()" class="secondary">Cr√©er un wallet</button>
            </div>
        </div>

        <!-- √âcran de cr√©ation -->
        <div id="createScreen" class="hidden">
            <div class="section">
                <h2>‚ú® Cr√©er un wallet s√©curis√©</h2>
                <input type="password" id="newPassword" placeholder="Mot de passe (min 8 caract√®res)">
                <input type="password" id="confirmPassword" placeholder="Confirmer">
                <input type="text" id="importPhrase" placeholder="(Optionnel) Phrase de r√©cup√©ration">
                <button onclick="createSecureWallet()">Cr√©er le wallet</button>
                <button onclick="showLoginScreen()" class="secondary">Retour</button>
                <div id="createMessage"></div>
                
                <div id="newWalletInfo" class="hidden">
                    <div class="info-box">
                        <label>‚ö†Ô∏è SAUVEGARDEZ CETTE PHRASE :</label>
                        <div id="displayMnemonic" style="font-weight: bold; color: #f59e0b;"></div>
                    </div>
                    <button onclick="confirmAndContinue()" class="success">‚úÖ J'ai sauvegard√©</button>
                </div>
            </div>
        </div>

        <!-- Interface principale avec navigation -->
        <div id="mainScreen" class="hidden">
            <!-- Navigation par onglets -->
            <div class="nav-tabs">
                <div class="nav-tab active" onclick="showPage('dashboard')">üìä Dashboard</div>
                <div class="nav-tab" onclick="showPage('tokens')">ü™ô Tokens</div>
                <div class="nav-tab" onclick="showPage('trading')">üí± Trading</div>
                <div class="nav-tab" onclick="showPage('security')">üõ°Ô∏è S√©curit√©</div>
                <div class="nav-tab" onclick="showPage('settings')">‚öôÔ∏è Param√®tres</div>
            </div>

            <!-- PAGE 1: DASHBOARD -->
            <div id="page-dashboard" class="page active">
                <div class="section">
                    <h2>üìä Mon Wallet</h2>
                    <div class="info-box">
                        <label>Adresse :</label>
                        <div id="walletAddress" style="color: #94a3b8; font-family: monospace;"></div>
                    </div>
                    <div class="balance" id="balance">0.0000 BNB</div>
                    <button onclick="refreshBalance()">üîÑ Actualiser</button>
                </div>

                <div class="section">
                    <h2>üìà Statistiques</h2>
                    <div class="stats">
                        <div class="stat-box">
                            <div class="stat-label">D√©pens√© aujourd'hui</div>
                            <div class="stat-value" id="dailySpent">0.0 BNB</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Transactions auto</div>
                            <div class="stat-value" id="autoApproved">0</div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2>üìã Historique r√©cent</h2>
                    <div id="transactionLogs"></div>
                </div>
            </div>

            <!-- PAGE 2: TOKENS -->
            <div id="page-tokens" class="page">
                <div class="section">
                    <h2>ü™ô Mes Tokens</h2>
                    <div class="token-grid" id="tokenBalances">
                        <div style="text-align: center; color: #64748b; padding: 20px;">
                            Chargement...
                        </div>
                    </div>
                    <button onclick="refreshAllTokens()" class="secondary">üîÑ Rafra√Æchir</button>
                </div>

                <div class="section">
                    <h2>‚ûï Ajouter un Token</h2>
                    <input type="text" id="tokenAddressInput" placeholder="Adresse du contrat (0x...)">
                    <button onclick="addTokenByAddress()">üîç Rechercher et ajouter</button>
                    <div id="tokenSearchResult"></div>
                    
                    <div class="info-box" style="margin-top: 15px;">
                        <label>üí° Tokens populaires BSC :</label>
                        <div style="color: #94a3b8; font-size: 12px; line-height: 1.6;">
                            <strong>USDT:</strong> 0x55d398326f99059fF775485246999027B3197955<br>
                            <strong>BTCB:</strong> 0x7130d2A12B9BCbFAe4f2634d864A1Ee1Ce3Ead9c
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAGE 3: TRADING -->
            <div id="page-trading" class="page">
                <div class="section">
                    <h2>üí± Envoyer / Trader</h2>
                    <input type="text" id="recipientAddress" placeholder="Adresse destinataire">
                    <input type="number" id="sendAmount" placeholder="Montant BNB" step="0.0001">
                    
                    <div id="safetyCheck" class="hidden"></div>
                    
                    <button onclick="prepareTransaction()" class="success">üöÄ Pr√©parer la transaction</button>
                    <div id="tradeMessage"></div>
                </div>

                <div class="section">
                    <h2>üîç Monitoring Temps R√©el</h2>
                    <div class="info-box">
                        <label>Statut :</label>
                        <div id="monitoringStatus" style="color: #10b981; font-weight: 700;">
                            ‚è≥ Initialisation...
                        </div>
                    </div>
                    <button onclick="forceCheckTransactions()" class="success">
                        üîÑ Scanner les transactions maintenant
                    </button>
                    <div id="lastCheckInfo" class="info-box" style="margin-top: 15px;">
                        <label>Derni√®re v√©rification :</label>
                        <div id="lastCheckTime" style="color: #64748b;">Jamais</div>
                    </div>
                </div>
            </div>

            <!-- PAGE 4: S√âCURIT√â -->
            <div id="page-security" class="page">
                <div class="section">
                    <h2>ü§ñ Telegram Bot</h2>
                    <input type="text" id="botTokenInput" placeholder="Bot Token (1234567890:ABC...)">
                    <button onclick="saveBotToken()">üíæ Enregistrer Bot Token</button>
                    
                    <div id="botTokenStatus" class="info-box" style="margin-top: 15px;">
                        <label>ü§ñ Statut :</label>
                        <div id="botTokenStatusText" style="color: #64748b;">Non configur√©</div>
                    </div>

                    <input type="text" id="newTelegramId" placeholder="Chat ID (123456789)" style="margin-top: 15px;">
                    <button onclick="updateTelegramId()">üíæ Enregistrer Chat ID</button>
                    
                    <div id="telegramStatus" class="info-box" style="margin-top: 15px;">
                        <label>üì± Chat ID :</label>
                        <div id="telegramStatusText" style="color: #64748b;">Non configur√©</div>
                    </div>

                    <button onclick="testTelegram()" class="secondary" style="margin-top: 15px;">üß™ Tester Telegram</button>
                </div>

                <div class="section">
                    <h2>üõ°Ô∏è Protection Anti-Scam</h2>
                    <button onclick="scanWalletTokens()" class="secondary">üîç Scanner mon wallet</button>
                    <div id="suspiciousTokenAlerts" class="hidden" style="margin-top: 15px;"></div>
                </div>

                <div class="section">
                    <h2>üìã Liste Blanche</h2>
                    <div id="whitelistDisplay" style="margin-bottom: 15px;"></div>
                    <input type="text" id="newWhitelistAddress" placeholder="0x... Adresse √† autoriser">
                    <button onclick="addToWhitelist()">‚ûï Ajouter</button>
                </div>
            </div>

            <!-- PAGE 5: PARAM√àTRES -->
            <div id="page-settings" class="page">
                <div class="section">
                    <h2>‚öôÔ∏è Limites de S√©curit√©</h2>
                    <input type="number" id="newMaxTx" placeholder="Max par transaction (BNB)" step="0.1">
                    <input type="number" id="newDailyLimit" placeholder="Limite quotidienne (BNB)" step="0.1">
                    <button onclick="updateLimits()">üíæ Mettre √† jour</button>
                    
                    <div class="stats" style="margin-top: 20px;">
                        <div class="stat-box">
                            <div class="stat-label">Max par transaction</div>
                            <div class="stat-value" id="maxPerTx">1.0 BNB</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Limite quotidienne</div>
                            <div class="stat-value" id="dailyLimit">10.0 BNB</div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2>üîê Applications de Confiance</h2>
                    <div id="trustedAppsDisplay" style="margin-bottom: 15px;"></div>
                    <input type="text" id="newTrustedApp" placeholder="Nom de l'app (ex: jercat-bot)">
                    <button onclick="addTrustedApp()">‚ûï Ajouter une app</button>
                </div>

                <div class="section">
                    <h2>üö® Actions</h2>
                    <button onclick="openTradingBot()" style="background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%); color: #000; margin-bottom: 10px;">
                        ü§ñ Ouvrir le Trading Bot
                    </button>
                    <button onclick="logout()" class="secondary">üîí Verrouiller le Wallet</button>
                    <button onclick="clearTelegramConfig()" class="danger">üóëÔ∏è Supprimer config Telegram</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const BSC_RPC = "https://bsc-dataseed.binance.org/";
        let provider = new ethers.JsonRpcProvider(BSC_RPC);
        let wallet = null;
        let TELEGRAM_BOT_TOKEN = localStorage.getItem('telegramBotToken') || '';

        let securityConfig = {
            maxPerTransaction: 1.0,
            dailyLimit: 10.0,
            dailySpent: 0.0,
            lastResetDate: new Date().toDateString(),
            telegramChatId: '',
            whitelist: ["0x10ED43C718714eb63d5aA57B78B54704E256024E"],
            transactionLogs: [],
            autoApprovedCount: 0,
            recentTransactions: [],
            autoRules: {
                whitelist: true,
                amount: true,
                frequency: true,
                time: true,
                trustedApps: true
            },
            autoAmountLimit: 0.1,
            trustedOrigins: [
                'jercat-wallet',
                'jercat-dex',
                'jercat-bot',
                'localhost',
                'wallet-one-ochre.vercel.app'
            ],
            knownTokens: [
                { address: '0x197CF8951d93325A9333857Ee5330daF7aC4bcCF', symbol: 'JERCAT', trusted: true },
                { address: '0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c', symbol: 'WBNB', trusted: true },
                { address: '0xe9e7CEA3DedcA5984780Bafc599bD69ADd087D56', symbol: 'BUSD', trusted: true },
                { address: '0x55d398326f99059fF775485246999027B3197955', symbol: 'USDT', trusted: true },
                { address: '0x0E09FaBB73Bd3Ade0a17ECC321fD13a19e81cE82', symbol: 'CAKE', trusted: true }
            ],
            suspiciousTokens: [],
            protectionSettings: {
                blockSuspiciousTokens: true,
                requireTelegramForNewTokens: true,
                autoScanIncoming: true
            }
        };

        const ERC20_ABI = [
            "function balanceOf(address owner) view returns (uint256)",
            "function decimals() view returns (uint8)",
            "function symbol() view returns (string)",
            "function name() view returns (string)"
        ];

        // NAVIGATION
        function showPage(pageName) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            
            document.getElementById('page-' + pageName).classList.add('active');
            event.target.classList.add('active');
        }

        // SAUVEGARDE / CHARGEMENT
        function loadConfig() {
            const saved = localStorage.getItem('securityConfig');
            if (saved) {
                securityConfig = { ...securityConfig, ...JSON.parse(saved) };
                checkDailyReset();
                updateStatsDisplay();
                updateWhitelistDisplay();
                updateLogsDisplay();
                updateTrustedAppsDisplay();
            }
        }

        function saveConfig() {
            localStorage.setItem('securityConfig', JSON.stringify(securityConfig));
        }

        function checkDailyReset() {
            const today = new Date().toDateString();
            if (securityConfig.lastResetDate !== today) {
                securityConfig.dailySpent = 0;
                securityConfig.autoApprovedCount = 0;
                securityConfig.lastResetDate = today;
                saveConfig();
            }
        }

        // WALLET MANAGEMENT
        function encryptAndSave(wallet, password) {
            const data = JSON.stringify({
                mnemonic: wallet.mnemonic.phrase,
                address: wallet.address
            });
            const encrypted = CryptoJS.AES.encrypt(data, password).toString();
            localStorage.setItem('encryptedWallet', encrypted);
        }

        function decryptWallet(password) {
            const encrypted = localStorage.getItem('encryptedWallet');
            if (!encrypted) return null;
            try {
                const decrypted = CryptoJS.AES.decrypt(encrypted, password).toString(CryptoJS.enc.Utf8);
                const data = JSON.parse(decrypted);
                return ethers.Wallet.fromPhrase(data.mnemonic);
            } catch (error) {
                return null;
            }
        }

        function createSecureWallet() {
            const password = document.getElementById('newPassword').value;
            const confirm = document.getElementById('confirmPassword').value;
            const importPhrase = document.getElementById('importPhrase').value.trim();
            const messageDiv = document.getElementById('createMessage');

            if (password.length < 8) {
                messageDiv.innerHTML = '<div class="error">‚ùå Mot de passe trop court.</div>';
                return;
            }

            if (password !== confirm) {
                messageDiv.innerHTML = '<div class="error">‚ùå Mots de passe diff√©rents.</div>';
                return;
            }

            try {
                wallet = importPhrase ? ethers.Wallet.fromPhrase(importPhrase) : ethers.Wallet.createRandom();
                encryptAndSave(wallet, password);
                saveConfig();

                document.getElementById('displayMnemonic').textContent = wallet.mnemonic.phrase;
                document.getElementById('newWalletInfo').classList.remove('hidden');
                messageDiv.innerHTML = '<div class="success-msg">‚úÖ Wallet cr√©√© !</div>';
            } catch (error) {
                messageDiv.innerHTML = '<div class="error">‚ùå ' + error.message + '</div>';
            }
        }

        function confirmAndContinue() {
            showMainScreen();
        }

        function login() {
            const password = document.getElementById('loginPassword').value;
            wallet = decryptWallet(password);

            if (wallet) {
                showMainScreen();
            } else {
                alert('‚ùå Mot de passe incorrect.');
            }
        }

        function showMainScreen() {
            wallet = wallet.connect(provider);
            document.getElementById('walletAddress').textContent = wallet.address;
            
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('createScreen').classList.add('hidden');
            document.getElementById('mainScreen').classList.remove('hidden');

            loadConfig();
            refreshBalance();
            updateBotTokenStatus();
            updateTelegramStatus();
            startTransactionMonitoring(wallet.address);
        }

        function logout() {
            wallet = null;
            stopTransactionMonitoring();
            document.getElementById('mainScreen').classList.add('hidden');
            showLoginScreen();
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('createScreen').classList.add('hidden');
            document.getElementById('loginPassword').value = '';
        }

        function showCreateScreen() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('createScreen').classList.remove('hidden');
        }

        // BALANCE & TOKENS
        async function refreshBalance() {
            if (!wallet) return;
            try {
                const balance = await provider.getBalance(wallet.address);
                document.getElementById('balance').textContent = parseFloat(ethers.formatEther(balance)).toFixed(4) + ' BNB';
                await loadTokenBalances();
            } catch (error) {
                console.error(error);
            }
        }

        async function loadTokenBalances() {
            if (!wallet) return;

            const tokenBalancesDiv = document.getElementById('tokenBalances');
            tokenBalancesDiv.innerHTML = '<div style="text-align: center; color: #64748b; padding: 20px;">üîÑ Chargement...</div>';

            try {
                const userAddress = wallet.address;
                const balances = [];

                for (const token of securityConfig.knownTokens) {
                    try {
                        const tokenContract = new ethers.Contract(token.address, ERC20_ABI, provider);
                        
                        const [balance, decimals, symbol] = await Promise.all([
                            tokenContract.balanceOf(userAddress),
                            tokenContract.decimals().catch(() => 18),
                            tokenContract.symbol().catch(() => token.symbol)
                        ]);

                        const formattedBalance = parseFloat(ethers.formatUnits(balance, decimals));

                        balances.push({
                            symbol: symbol,
                            balance: formattedBalance,
                            trusted: token.trusted
                        });

                    } catch (error) {
                        console.error(`Erreur ${token.symbol}:`, error);
                    }
                }

                if (balances.length === 0) {
                    tokenBalancesDiv.innerHTML = '<div style="text-align: center; color: #64748b; padding: 20px;">Aucun token</div>';
                } else {
                    tokenBalancesDiv.innerHTML = '';
                    
                    balances.forEach(token => {
                        const balanceColor = token.balance > 0 ? '#10b981' : '#64748b';
                        const trustBadge = token.trusted ? '<div style="position: absolute; top: 8px; right: 8px; background: #10b981; color: white; padding: 2px 6px; border-radius: 4px; font-size: 9px;">‚úì</div>' : '';
                        
                        const tokenCard = document.createElement('div');
                        tokenCard.className = 'token-card';
                        tokenCard.innerHTML = `
                            ${trustBadge}
                            <div style="font-size: 24px; margin-bottom: 8px;">ü™ô</div>
                            <div style="color: #f59e0b; font-weight: 700; font-size: 16px; margin-bottom: 4px;">${token.symbol}</div>
                            <div style="color: ${balanceColor}; font-weight: 900; font-size: 20px;">
                                ${token.balance.toFixed(token.balance > 1 ? 2 : 6)}
                            </div>
                        `;
                        tokenBalancesDiv.appendChild(tokenCard);
                    });
                }

            } catch (error) {
                console.error('Erreur tokens:', error);
                tokenBalancesDiv.innerHTML = '<div style="text-align: center; color: #dc2626; padding: 20px;">‚ùå Erreur</div>';
            }
        }

        async function addTokenByAddress() {
            const address = document.getElementById('tokenAddressInput').value.trim();
            const resultDiv = document.getElementById('tokenSearchResult');

            if (!address || !ethers.isAddress(address)) {
                resultDiv.innerHTML = '<div class="error">‚ùå Adresse invalide</div>';
                return;
            }

            resultDiv.innerHTML = '<div class="info-box">üîç Recherche...</div>';

            try {
                const tokenContract = new ethers.Contract(address, ERC20_ABI, provider);
                
                const [symbol, name, balance] = await Promise.all([
                    tokenContract.symbol(),
                    tokenContract.name(),
                    tokenContract.balanceOf(wallet.address)
                ]);

                const alreadyAdded = securityConfig.knownTokens.some(t => t.address.toLowerCase() === address.toLowerCase());

                if (alreadyAdded) {
                    resultDiv.innerHTML = '<div class="warning">‚ÑπÔ∏è Token d√©j√† ajout√©</div>';
                    await loadTokenBalances();
                    return;
                }

                resultDiv.innerHTML = `
                    <div class="success-msg">
                        ‚úÖ ${name} (${symbol}) trouv√© !<br>
                        <button onclick="confirmAddToken('${address}', '${symbol}', '${name}')" class="success" style="margin-top: 10px;">
                            Ajouter ${symbol}
                        </button>
                    </div>
                `;

            } catch (error) {
                resultDiv.innerHTML = '<div class="error">‚ùå ' + error.message + '</div>';
            }
        }

        function confirmAddToken(address, symbol, name) {
            securityConfig.knownTokens.push({
                address: address,
                symbol: symbol,
                name: name,
                trusted: true,
                addedAt: new Date().toISOString()
            });

            saveConfig();

            document.getElementById('tokenAddressInput').value = '';
            document.getElementById('tokenSearchResult').innerHTML = '<div class="success-msg">‚úÖ ' + symbol + ' ajout√© !</div>';

            loadTokenBalances();

            if (TELEGRAM_BOT_TOKEN && securityConfig.telegramChatId) {
                sendTelegramMessage(`ü™ô <b>Nouveau token ajout√©</b>\n\n‚úÖ ${name} (${symbol})\nüìç ${address}`);
            }
        }

        async function refreshAllTokens() {
            await loadTokenBalances();
        }

        // TELEGRAM
        function saveBotToken() {
            const token = document.getElementById('botTokenInput').value.trim();
            
            if (!token) {
                alert('‚ùå Entrez un token');
                return;
            }

            const tokenPattern = /^\d{8,10}:[A-Za-z0-9_-]{35}$/;
            if (!tokenPattern.test(token)) {
                alert('‚ö†Ô∏è Format de token invalide');
                return;
            }

            localStorage.setItem('telegramBotToken', token);
            TELEGRAM_BOT_TOKEN = token;
            
            updateBotTokenStatus();
            alert('‚úÖ Bot Token enregistr√© !');
        }

        function updateBotTokenStatus() {
            const statusDiv = document.getElementById('botTokenStatusText');
            const tokenInput = document.getElementById('botTokenInput');
            
            if (TELEGRAM_BOT_TOKEN) {
                const maskedToken = TELEGRAM_BOT_TOKEN.substring(0, 10) + '...' + TELEGRAM_BOT_TOKEN.slice(-10);
                statusDiv.innerHTML = `<span style="color: #10b981; font-weight: 700;">‚úÖ Configur√©</span><br><span style="color: #64748b; font-size: 12px;">${maskedToken}</span>`;
                tokenInput.value = maskedToken;
            } else {
                statusDiv.innerHTML = '<span style="color: #dc2626; font-weight: 700;">‚ùå Non configur√©</span>';
                tokenInput.value = '';
            }
        }

        function updateTelegramId() {
            const chatId = document.getElementById('newTelegramId').value.trim();
            if (chatId && chatId.match(/^[0-9]{6,12}$/)) {
                securityConfig.telegramChatId = chatId;
                saveConfig();
                updateTelegramStatus();
                alert('‚úÖ Chat ID sauvegard√© !');
            } else {
                alert('‚ùå Chat ID invalide');
            }
        }

        function updateTelegramStatus() {
            const statusDiv = document.getElementById('telegramStatusText');
            const chatIdInput = document.getElementById('newTelegramId');
            
            if (securityConfig.telegramChatId) {
                statusDiv.innerHTML = `<span style="color: #10b981; font-weight: 700;">‚úÖ Configur√© (${securityConfig.telegramChatId})</span>`;
                chatIdInput.value = securityConfig.telegramChatId;
            } else {
                statusDiv.innerHTML = '<span style="color: #dc2626; font-weight: 700;">‚ùå Non configur√©</span>';
                chatIdInput.value = '';
            }
        }

        async function testTelegram() {
            if (!TELEGRAM_BOT_TOKEN || !securityConfig.telegramChatId) {
                alert('‚ùå Configurez Bot Token et Chat ID d\'abord');
                return;
            }

            try {
                await sendTelegramMessage('üß™ <b>Test</b>\n\n‚úÖ Configuration OK !');
                alert('‚úÖ Message envoy√© ! V√©rifiez Telegram.');
            } catch (error) {
                alert('‚ùå Erreur: ' + error.message);
            }
        }

        function clearTelegramConfig() {
            if (!confirm('‚ö†Ô∏è Supprimer la config Telegram ?')) return;

            localStorage.removeItem('telegramBotToken');
            TELEGRAM_BOT_TOKEN = '';
            securityConfig.telegramChatId = '';
            saveConfig();

            document.getElementById('botTokenInput').value = '';
            document.getElementById('newTelegramId').value = '';
            updateBotTokenStatus();
            updateTelegramStatus();

            alert('‚úÖ Configuration supprim√©e');
        }

        async function sendTelegramMessage(message, showButtons = false) {
            if (!TELEGRAM_BOT_TOKEN || !securityConfig.telegramChatId) {
                console.log('üì± TELEGRAM (simulation):\n', message);
                return { ok: true, mode: 'simulation' };
            }

            const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
            
            const payload = {
                chat_id: securityConfig.telegramChatId,
                text: message,
                parse_mode: 'HTML'
            };

            if (showButtons) {
                payload.reply_markup = {
                    inline_keyboard: [[
                        { text: '‚úÖ Approuver', callback_data: 'approve' },
                        { text: '‚ùå Refuser', callback_data: 'reject' }
                    ]]
                };
            }

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.description || 'Erreur Telegram');
                }

                return { ok: true, mode: 'real', data: data };
            } catch (error) {
                console.error('‚ùå Telegram:', error);
                throw error;
            }
        }

        // TRANSACTIONS
        async function prepareTransaction() {
            const recipient = document.getElementById('recipientAddress').value.trim();
            const amount = parseFloat(document.getElementById('sendAmount').value);
            const messageDiv = document.getElementById('tradeMessage');

            if (!recipient || !amount || !ethers.isAddress(recipient)) {
                messageDiv.innerHTML = '<div class="error">‚ùå V√©rifiez les champs</div>';
                return;
            }

            try {
                checkDailyReset();
                
                if (amount > securityConfig.maxPerTransaction) {
                    throw new Error(`Limite: ${securityConfig.maxPerTransaction} BNB`);
                }

                if (securityConfig.dailySpent + amount > securityConfig.dailyLimit) {
                    throw new Error('Limite quotidienne d√©pass√©e');
                }

                await executeTransaction(recipient, amount, false);

            } catch (error) {
                messageDiv.innerHTML = '<div class="error">‚ùå ' + error.message + '</div>';
            }
        }

        async function executeTransaction(recipient, amount, isAuto) {
            const messageDiv = document.getElementById('tradeMessage');

            try {
                const tx = await wallet.sendTransaction({
                    to: recipient,
                    value: ethers.parseEther(amount.toString())
                });

                messageDiv.innerHTML = '<div class="success-msg">‚è≥ Transaction envoy√©e !</div>';

                await tx.wait();

                securityConfig.dailySpent += amount;
                if (isAuto) securityConfig.autoApprovedCount++;

                securityConfig.transactionLogs.unshift({
                    time: new Date().toLocaleString(),
                    amount: amount,
                    to: recipient,
                    hash: tx.hash,
                    status: 'success',
                    autoApproved: isAuto
                });

                if (securityConfig.transactionLogs.length > 20) {
                    securityConfig.transactionLogs = securityConfig.transactionLogs.slice(0, 20);
                }

                saveConfig();
                updateStatsDisplay();
                updateLogsDisplay();
                refreshBalance();

                document.getElementById('recipientAddress').value = '';
                document.getElementById('sendAmount').value = '';
                
                messageDiv.innerHTML = '<div class="success-msg">‚úÖ Transaction confirm√©e !</div>';

                await sendTelegramMessage(`‚úÖ <b>Transaction confirm√©e</b>\n\nüí∞ ${amount} BNB\nüìç ${recipient.substring(0,20)}...\nüîó ${tx.hash.substring(0,20)}...`);

            } catch (error) {
                messageDiv.innerHTML = '<div class="error">‚ùå ' + error.message + '</div>';
            }
        }

        // MONITORING
        let monitoringInterval = null;
        let lastCheckedBlock = null;

        async function startTransactionMonitoring(walletAddress) {
            const currentBlock = await provider.getBlockNumber();
            
            const savedBlock = localStorage.getItem('lastCheckedBlock');
            if (savedBlock) {
                lastCheckedBlock = parseInt(savedBlock);
            } else {
                lastCheckedBlock = currentBlock - 1000;
            }

            updateMonitoringStatus(`‚úÖ Actif - Bloc: ${currentBlock}`);

            await checkNewTransactions(walletAddress);

            monitoringInterval = setInterval(async () => {
                try {
                    await checkNewTransactions(walletAddress);
                } catch (error) {
                    console.error('Erreur monitoring:', error);
                }
            }, 10000);
        }

        function stopTransactionMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
            }
        }

        function updateMonitoringStatus(message) {
            const statusDiv = document.getElementById('monitoringStatus');
            if (statusDiv) {
                statusDiv.textContent = message;
            }
            
            const lastCheckDiv = document.getElementById('lastCheckTime');
            if (lastCheckDiv) {
                lastCheckDiv.textContent = new Date().toLocaleString('fr-FR');
            }
        }

        async function forceCheckTransactions() {
            if (!wallet) {
                alert('‚ùå Wallet non d√©verrouill√©');
                return;
            }

            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = 'üîç Scan en cours...';

            try {
                updateMonitoringStatus('üîç Scan forc√©...');
                
                const currentBlock = await provider.getBlockNumber();
                const startBlock = currentBlock - 5000;
                lastCheckedBlock = startBlock;
                
                await checkNewTransactions(wallet.address);
                
                updateMonitoringStatus(`‚úÖ Scan termin√© - Bloc: ${currentBlock}`);
                alert('‚úÖ Scan termin√© !');
                
            } catch (error) {
                console.error(error);
                alert('‚ùå Erreur: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üîÑ Scanner les transactions maintenant';
            }
        }

        async function checkNewTransactions(walletAddress) {
            const currentBlock = await provider.getBlockNumber();
            
            if (!lastCheckedBlock) {
                lastCheckedBlock = currentBlock - 100;
            }

            const blocksToCheck = currentBlock - lastCheckedBlock;
            updateMonitoringStatus(`üîç Scan de ${blocksToCheck} blocs...`);

            let foundCount = 0;

            for (let blockNumber = lastCheckedBlock + 1; blockNumber <= currentBlock; blockNumber++) {
                try {
                    const block = await provider.getBlock(blockNumber, true);
                    
                    if (block && block.transactions) {
                        for (let tx of block.transactions) {
                            if (typeof tx === 'object' && tx.from && tx.from.toLowerCase() === walletAddress.toLowerCase()) {
                                await handleExternalTransaction(tx);
                                foundCount++;
                            }
                        }
                    }
                } catch (error) {
                    console.error(`Erreur bloc ${blockNumber}:`, error);
                }
            }

            lastCheckedBlock = currentBlock;
            localStorage.setItem('lastCheckedBlock', currentBlock.toString());

            updateMonitoringStatus(foundCount > 0 ? `‚úÖ ${foundCount} tx d√©tect√©e(s)` : `‚úÖ Aucune nouvelle tx`);
        }

        async function handleExternalTransaction(tx) {
            const txId = tx.hash;
            const processedTxs = JSON.parse(localStorage.getItem('processedExternalTxs') || '[]');
            
            if (processedTxs.includes(txId)) {
                return;
            }

            processedTxs.push(txId);
            if (processedTxs.length > 100) {
                processedTxs.shift();
            }
            localStorage.setItem('processedExternalTxs', JSON.stringify(processedTxs));

            const receipt = await provider.getTransactionReceipt(txId);
            
            if (!receipt) return;

            const amount = parseFloat(ethers.formatEther(tx.value));
            const to = tx.to || 'Contract';
            const gasUsed = receipt.gasUsed;
            const gasPrice = tx.gasPrice;
            const gasCost = parseFloat(ethers.formatEther(gasUsed * gasPrice));
            const timestamp = new Date().toLocaleString();

            securityConfig.transactionLogs.unshift({
                time: timestamp,
                amount: amount,
                to: to,
                hash: txId,
                status: receipt.status === 1 ? 'success' : 'failed',
                external: true,
                gasCost: gasCost
            });

            if (securityConfig.transactionLogs.length > 20) {
                securityConfig.transactionLogs = securityConfig.transactionLogs.slice(0, 20);
            }

            saveConfig();
            updateLogsDisplay();

            if (TELEGRAM_BOT_TOKEN && securityConfig.telegramChatId) {
                const emoji = receipt.status === 1 ? '‚úÖ' : '‚ùå';
                const message = `${emoji} <b>Transaction ${receipt.status === 1 ? 'Confirm√©e' : '√âchou√©e'} (Externe)</b>\n\nüí∞ ${amount.toFixed(4)} BNB\nüìç ${to}\n‚õΩ Gas: ${gasCost.toFixed(6)} BNB\nüîó ${txId.substring(0,20)}...\n‚è∞ ${timestamp}`;
                
                try {
                    await sendTelegramMessage(message);
                } catch (error) {
                    console.error('Erreur Telegram:', error);
                }
            }

            refreshBalance();
        }

        // SECURITY
        function addToWhitelist() {
            const address = document.getElementById('newWhitelistAddress').value.trim();
            if (address && ethers.isAddress(address)) {
                if (!securityConfig.whitelist.includes(address)) {
                    securityConfig.whitelist.push(address);
                    saveConfig();
                    updateWhitelistDisplay();
                    document.getElementById('newWhitelistAddress').value = '';
                    alert('‚úÖ Ajout√© !');
                } else {
                    alert('‚ÑπÔ∏è D√©j√† pr√©sent.');
                }
            } else {
                alert('‚ùå Adresse invalide.');
            }
        }

        function removeFromWhitelist(address) {
            securityConfig.whitelist = securityConfig.whitelist.filter(addr => addr !== address);
            saveConfig();
            updateWhitelistDisplay();
        }

        function updateWhitelistDisplay() {
            const div = document.getElementById('whitelistDisplay');
            if (!div) return;
            div.innerHTML = '';
            securityConfig.whitelist.forEach(address => {
                const item = document.createElement('div');
                item.style.cssText = 'background: #0f172a; padding: 10px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border: 2px solid #334155; font-size: 12px;';
                item.innerHTML = `
                    <span style="color: #94a3b8; font-family: monospace;">${address.substring(0,20)}...</span>
                    <button onclick="removeFromWhitelist('${address}')" class="danger" style="width: auto; padding: 6px 12px; font-size: 12px; margin: 0;">‚ùå</button>
                `;
                div.appendChild(item);
            });
        }

        function addTrustedApp() {
            const appName = document.getElementById('newTrustedApp').value.trim().toLowerCase();
            
            if (!appName) {
                alert('‚ùå Entrez un nom');
                return;
            }

            if (securityConfig.trustedOrigins.includes(appName)) {
                alert('‚ÑπÔ∏è D√©j√† de confiance');
                return;
            }

            securityConfig.trustedOrigins.push(appName);
            saveConfig();
            updateTrustedAppsDisplay();
            document.getElementById('newTrustedApp').value = '';
            alert(`‚úÖ "${appName}" ajout√©e !`);
        }

        function removeTrustedApp(appName) {
            securityConfig.trustedOrigins = securityConfig.trustedOrigins.filter(app => app !== appName);
            saveConfig();
            updateTrustedAppsDisplay();
        }

        function updateTrustedAppsDisplay() {
            const div = document.getElementById('trustedAppsDisplay');
            if (!div) return;
            
            div.innerHTML = '';
            
            securityConfig.trustedOrigins.forEach(appName => {
                const item = document.createElement('div');
                item.style.cssText = 'background: #0f172a; padding: 10px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border: 2px solid #334155;';
                item.innerHTML = `
                    <div>
                        <span style="color: #10b981; font-weight: 700;">üîê ${appName}</span>
                    </div>
                    <button onclick="removeTrustedApp('${appName}')" class="danger" style="width: auto; padding: 6px 12px; margin: 0;">‚ùå</button>
                `;
                div.appendChild(item);
            });
        }

        function updateLimits() {
            const newMaxTx = parseFloat(document.getElementById('newMaxTx').value);
            const newDaily = parseFloat(document.getElementById('newDailyLimit').value);

            if (newMaxTx > 0) securityConfig.maxPerTransaction = newMaxTx;
            if (newDaily > 0) securityConfig.dailyLimit = newDaily;

            saveConfig();
            updateStatsDisplay();
            alert('‚úÖ Limites mises √† jour !');
        }

        function scanWalletTokens() {
            alert('üîç Scanner de tokens non impl√©ment√© dans cette version simplifi√©e');
        }

        // ü§ñ OUVRIR LE TRADING BOT AVEC CONNEXION COMPL√àTE
        function openTradingBot() {
            if (!wallet) {
                alert('‚ùå Veuillez d√©verrouiller votre wallet d\'abord !');
                return;
            }

            console.log('ü§ñ Ouverture du Trading Bot JERCAT...');
            
            // Demander si l'utilisateur veut activer le trading automatique
            const autoTrading = confirm(
                'ü§ñ Activer le trading automatique ?\n\n' +
                '‚úÖ OUI = Le bot pourra trader sans confirmation (cl√© priv√©e envoy√©e)\n' +
                '‚ùå NON = Mode lecture seule (adresse uniquement)'
            );

            // Ouvrir le bot dans une nouvelle fen√™tre
            const botWindow = window.open(
                'jercat-bot-wallet-integration.html', // Adapter selon votre URL
                'JercatBot', 
                'width=1400,height=900,resizable=yes,scrollbars=yes'
            );
            
            if (!botWindow) {
                alert('‚ùå Popup bloqu√©e ! Autorisez les popups pour ce site.');
                return;
            }

            // Envoyer les informations de connexion apr√®s chargement
            setTimeout(() => {
                try {
                    const connectionData = {
                        type: 'JERCAT_WALLET_CONNECTED',
                        account: wallet.address,
                        privateKey: autoTrading ? wallet.privateKey : null,
                        timestamp: Date.now()
                    };

                    botWindow.postMessage(connectionData, '*');
                    
                    console.log('‚úÖ Connexion envoy√©e au bot');
                    console.log('üìç Adresse:', wallet.address);
                    console.log('üîë Mode:', autoTrading ? 'Auto-Trading' : 'Lecture seule');

                    // √âtablir la confiance
                    if (botWindow.establishJercatTrust) {
                        botWindow.establishJercatTrust('jercat-wallet');
                    }

                    // Notification Telegram
                    if (TELEGRAM_BOT_TOKEN && securityConfig.telegramChatId) {
                        sendTelegramMessage(
                            `ü§ñ <b>Trading Bot ouvert</b>\n\n` +
                            `üìç ${wallet.address}\n` +
                            `üîë Mode: ${autoTrading ? 'Auto-Trading ‚úÖ' : 'Lecture seule üëÅÔ∏è'}\n` +
                            `‚è∞ ${new Date().toLocaleString()}`
                        ).catch(err => console.log('Telegram:', err));
                    }

                } catch (error) {
                    console.error('‚ùå Erreur envoi donn√©es:', error);
                }
            }, 2000);

            alert(
                '‚úÖ Trading Bot ouvert !\n\n' +
                (autoTrading ? 
                    'ü§ñ Mode AUTO-TRADING activ√©\n' +
                    '‚úÖ Les trades seront ex√©cut√©s sans confirmation' :
                    'üëÅÔ∏è Mode LECTURE SEULE\n' +
                    '‚ÑπÔ∏è Vous pourrez configurer le bot mais pas trader'
                )
            );
        }

        // DISPLAY UPDATES
        function updateStatsDisplay() {
            const maxTx = document.getElementById('maxPerTx');
            const dailyLim = document.getElementById('dailyLimit');
            const dailySp = document.getElementById('dailySpent');
            const autoApp = document.getElementById('autoApproved');

            if (maxTx) maxTx.textContent = securityConfig.maxPerTransaction + ' BNB';
            if (dailyLim) dailyLim.textContent = securityConfig.dailyLimit + ' BNB';
            if (dailySp) dailySp.textContent = securityConfig.dailySpent.toFixed(4) + ' BNB';
            if (autoApp) autoApp.textContent = securityConfig.autoApprovedCount || 0;
        }

        function updateLogsDisplay() {
            const div = document.getElementById('transactionLogs');
            if (!div) return;
            div.innerHTML = '';
            
            if (securityConfig.transactionLogs.length === 0) {
                div.innerHTML = '<p style="text-align: center; color: #64748b;">Aucune transaction</p>';
                return;
            }

            securityConfig.transactionLogs.slice(0, 5).forEach(log => {
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                const statusColor = log.status === 'success' ? '#10b981' : '#dc2626';
                
                let badge = '';
                if (log.external) {
                    badge = '<span class="badge badge-warning">‚ö†Ô∏è EXTERNE</span>';
                } else if (log.autoApproved) {
                    badge = '<span class="badge badge-success">ü§ñ AUTO</span>';
                }
                
                entry.innerHTML = `
                    <div style="font-size: 11px; color: #64748b; margin-bottom: 5px;">${log.time}</div>
                    <div><strong style="color: ${statusColor}">${log.status === 'success' ? '‚úÖ' : '‚ùå'} ${log.amount} BNB</strong>${badge}</div>
                    <div style="font-size: 11px; color: #64748b;">‚Üí ${log.to.substring(0,15)}...</div>
                `;
                div.appendChild(entry);
            });
        }

        window.onload = function() {
            const hasWallet = localStorage.getItem('encryptedWallet');
            if (!hasWallet) {
                showCreateScreen();
            }
        };
    </script>
</body>
</html>
