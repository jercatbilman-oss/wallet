<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Trading Wallet</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            text-align: center;
            color: #1e3c72;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .section {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .section h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #1e3c72;
        }

        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-bottom: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(30, 60, 114, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button.danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        button.success {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
        }

        button.secondary {
            background: #6c757d;
        }

        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 10px;
        }

        input:focus {
            outline: none;
            border-color: #1e3c72;
        }

        .warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #856404;
        }

        .error {
            background: #f8d7da;
            border: 2px solid #dc3545;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            color: #721c24;
        }

        .success-msg {
            background: #d4edda;
            border: 2px solid #28a745;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            color: #155724;
        }

        .info-box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            word-break: break-all;
            font-size: 14px;
            border: 2px solid #e9ecef;
        }

        .info-box label {
            font-weight: 600;
            color: #1e3c72;
            display: block;
            margin-bottom: 8px;
        }

        .hidden {
            display: none;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .stat-box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #1e3c72;
        }

        .balance {
            font-size: 32px;
            font-weight: bold;
            color: #1e3c72;
            text-align: center;
            margin: 20px 0;
        }

        .log-entry {
            background: white;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid #1e3c72;
            font-size: 13px;
        }

        .log-time {
            color: #666;
            font-size: 11px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-stopped {
            background: #f8d7da;
            color: #721c24;
        }

        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 10px;
            background: white;
        }

        .whitelist-item {
            background: white;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 2px solid #e9ecef;
        }

        .whitelist-item button {
            width: auto;
            padding: 6px 12px;
            font-size: 12px;
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Secure Trading Wallet</h1>
        <p class="subtitle">Bot de Trading S√©curis√© sur BSC</p>

        <div class="warning">
            <strong>‚ö†Ô∏è S√âCURIT√â</strong>
            Ce wallet utilise un chiffrement AES-256. D√©finissez un mot de passe FORT. Ne l'utilisez QUE pour le trading avec des montants limit√©s. Pour le stockage principal, utilisez MetaMask ou Ledger.
        </div>

        <!-- √âcran de connexion/cr√©ation -->
        <div id="loginScreen">
            <div class="section">
                <h2>Connexion</h2>
                <input type="password" id="loginPassword" placeholder="Entrez votre mot de passe">
                <button onclick="login()">D√©verrouiller le wallet</button>
                <button onclick="showCreateScreen()" class="secondary">Cr√©er un nouveau wallet</button>
            </div>
        </div>

        <!-- √âcran de cr√©ation -->
        <div id="createScreen" class="hidden">
            <div class="section">
                <h2>Cr√©er un wallet s√©curis√©</h2>
                <input type="password" id="newPassword" placeholder="Mot de passe (min 8 caract√®res)">
                <input type="password" id="confirmPassword" placeholder="Confirmer le mot de passe">
                <input type="text" id="importPhrase" placeholder="(Optionnel) Phrase de r√©cup√©ration existante">
                <button onclick="createSecureWallet()">Cr√©er le wallet</button>
                <button onclick="showLoginScreen()" class="secondary">Retour</button>
                <div id="createMessage"></div>
                
                <div id="newWalletInfo" class="hidden">
                    <div class="info-box">
                        <label>‚ö†Ô∏è SAUVEGARDEZ CETTE PHRASE (12 mots) :</label>
                        <div id="displayMnemonic" style="font-weight: bold; color: #dc3545;"></div>
                    </div>
                    <button onclick="confirmAndContinue()" class="success">J'ai sauvegard√© ma phrase</button>
                </div>
            </div>
        </div>

        <!-- √âcran principal -->
        <div id="mainScreen" class="hidden">
            <!-- En-t√™te avec statut -->
            <div class="section">
                <h2>
                    Dashboard
                    <span id="botStatus" class="status-badge status-active">Bot Actif</span>
                </h2>
                <div class="info-box">
                    <label>Adresse du wallet :</label>
                    <div id="walletAddress"></div>
                </div>
                <div class="balance" id="balance">0.0000 BNB</div>
                <button onclick="refreshBalance()">üîÑ Actualiser</button>
            </div>

            <!-- Statistiques -->
            <div class="section">
                <h2>Limites & Statistiques</h2>
                <div class="stats">
                    <div class="stat-box">
                        <div class="stat-label">Max par transaction</div>
                        <div class="stat-value" id="maxPerTx">1.0 BNB</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Limite quotidienne</div>
                        <div class="stat-value" id="dailyLimit">10.0 BNB</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">D√©pens√© aujourd'hui</div>
                        <div class="stat-value" id="dailySpent">0.0 BNB</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Restant aujourd'hui</div>
                        <div class="stat-value" id="dailyRemaining">10.0 BNB</div>
                    </div>
                </div>
            </div>

            <!-- Configuration des limites -->
            <div class="section">
                <h2>‚öôÔ∏è Configuration des limites</h2>
                <input type="number" id="newMaxTx" placeholder="Max par transaction (BNB)" step="0.1">
                <input type="number" id="newDailyLimit" placeholder="Limite quotidienne (BNB)" step="0.1">
                <button onclick="updateLimits()">Mettre √† jour les limites</button>
            </div>

            <!-- Liste blanche -->
            <div class="section">
                <h2>üõ°Ô∏è Liste blanche (Adresses autoris√©es)</h2>
                <div id="whitelistDisplay"></div>
                <input type="text" id="newWhitelistAddress" placeholder="0x... Adresse √† autoriser">
                <button onclick="addToWhitelist()">Ajouter √† la liste blanche</button>
            </div>

            <!-- Trading -->
            <div class="section">
                <h2>üí± Envoyer / Trader</h2>
                <select id="tokenSelect">
                    <option value="BNB">BNB (Natif)</option>
                </select>
                <input type="text" id="recipientAddress" placeholder="Adresse destinataire">
                <input type="number" id="sendAmount" placeholder="Montant" step="0.0001">
                <button onclick="executeTrade()" id="tradeBtn">Envoyer</button>
                <div id="tradeMessage"></div>
            </div>

            <!-- Logs des transactions -->
            <div class="section">
                <h2>üìã Historique des transactions</h2>
                <div id="transactionLogs"></div>
            </div>

            <!-- Contr√¥les d'urgence -->
            <div class="section">
                <h2>üö® Contr√¥les d'urgence</h2>
                <button onclick="toggleEmergencyStop()" class="danger" id="emergencyBtn">ARR√äT D'URGENCE</button>
                <button onclick="logout()" class="secondary">Verrouiller le wallet</button>
            </div>
        </div>
    </div>

    <script>
        const BSC_RPC = "https://bsc-dataseed.binance.org/";
        let provider = new ethers.JsonRpcProvider(BSC_RPC);
        let wallet = null;
        let encryptedWallet = null;

        // Configuration de s√©curit√©
        let securityConfig = {
            maxPerTransaction: 1.0, // BNB
            dailyLimit: 10.0, // BNB
            dailySpent: 0.0,
            lastResetDate: new Date().toDateString(),
            whitelist: [
                "0x10ED43C718714eb63d5aA57B78B54704E256024E", // PancakeSwap Router
            ],
            emergencyStop: false,
            transactionLogs: []
        };

        // Charger la config depuis le stockage
        function loadConfig() {
            const saved = localStorage.getItem('securityConfig');
            if (saved) {
                const loaded = JSON.parse(saved);
                securityConfig = { ...securityConfig, ...loaded };
                checkDailyReset();
                updateStatsDisplay();
                updateWhitelistDisplay();
                updateLogsDisplay();
                updateBotStatus();
            }
        }

        // Sauvegarder la config
        function saveConfig() {
            localStorage.setItem('securityConfig', JSON.stringify(securityConfig));
        }

        // V√©rifier et reset quotidien
        function checkDailyReset() {
            const today = new Date().toDateString();
            if (securityConfig.lastResetDate !== today) {
                securityConfig.dailySpent = 0;
                securityConfig.lastResetDate = today;
                saveConfig();
            }
        }

        // Chiffrer et sauvegarder le wallet
        function encryptAndSave(wallet, password) {
            const data = JSON.stringify({
                mnemonic: wallet.mnemonic.phrase,
                address: wallet.address
            });
            const encrypted = CryptoJS.AES.encrypt(data, password).toString();
            localStorage.setItem('encryptedWallet', encrypted);
            return encrypted;
        }

        // D√©chiffrer le wallet
        function decryptWallet(password) {
            const encrypted = localStorage.getItem('encryptedWallet');
            if (!encrypted) return null;
            
            try {
                const decrypted = CryptoJS.AES.decrypt(encrypted, password).toString(CryptoJS.enc.Utf8);
                const data = JSON.parse(decrypted);
                return ethers.Wallet.fromPhrase(data.mnemonic);
            } catch (error) {
                return null;
            }
        }

        // Cr√©er un wallet s√©curis√©
        function createSecureWallet() {
            const password = document.getElementById('newPassword').value;
            const confirm = document.getElementById('confirmPassword').value;
            const importPhrase = document.getElementById('importPhrase').value.trim();
            const messageDiv = document.getElementById('createMessage');

            if (password.length < 8) {
                messageDiv.innerHTML = '<div class="error">Le mot de passe doit contenir au moins 8 caract√®res.</div>';
                return;
            }

            if (password !== confirm) {
                messageDiv.innerHTML = '<div class="error">Les mots de passe ne correspondent pas.</div>';
                return;
            }

            try {
                // Cr√©er ou importer le wallet
                if (importPhrase) {
                    wallet = ethers.Wallet.fromPhrase(importPhrase);
                } else {
                    wallet = ethers.Wallet.createRandom();
                }

                // Chiffrer et sauvegarder
                encryptAndSave(wallet, password);

                // Afficher la phrase de r√©cup√©ration
                document.getElementById('displayMnemonic').textContent = wallet.mnemonic.phrase;
                document.getElementById('newWalletInfo').classList.remove('hidden');
                messageDiv.innerHTML = '<div class="success-msg">‚úÖ Wallet cr√©√© et chiffr√© avec succ√®s !</div>';

            } catch (error) {
                messageDiv.innerHTML = '<div class="error">Erreur : ' + error.message + '</div>';
            }
        }

        // Confirmer et continuer
        function confirmAndContinue() {
            showMainScreen();
        }

        // Connexion
        function login() {
            const password = document.getElementById('loginPassword').value;
            wallet = decryptWallet(password);

            if (wallet) {
                showMainScreen();
            } else {
                alert('‚ùå Mot de passe incorrect ou wallet non trouv√©.');
            }
        }

        // Afficher l'√©cran principal
        function showMainScreen() {
            wallet = wallet.connect(provider);
            document.getElementById('walletAddress').textContent = wallet.address;
            
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('createScreen').classList.add('hidden');
            document.getElementById('mainScreen').classList.remove('hidden');

            loadConfig();
            refreshBalance();
        }

        // Actualiser le solde
        async function refreshBalance() {
            if (!wallet) return;
            try {
                const balance = await provider.getBalance(wallet.address);
                document.getElementById('balance').textContent = parseFloat(ethers.formatEther(balance)).toFixed(4) + ' BNB';
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        // Mettre √† jour l'affichage des stats
        function updateStatsDisplay() {
            document.getElementById('maxPerTx').textContent = securityConfig.maxPerTransaction + ' BNB';
            document.getElementById('dailyLimit').textContent = securityConfig.dailyLimit + ' BNB';
            document.getElementById('dailySpent').textContent = securityConfig.dailySpent.toFixed(4) + ' BNB';
            document.getElementById('dailyRemaining').textContent = (securityConfig.dailyLimit - securityConfig.dailySpent).toFixed(4) + ' BNB';
        }

        // Mettre √† jour les limites
        function updateLimits() {
            const newMaxTx = parseFloat(document.getElementById('newMaxTx').value);
            const newDaily = parseFloat(document.getElementById('newDailyLimit').value);

            if (newMaxTx > 0) securityConfig.maxPerTransaction = newMaxTx;
            if (newDaily > 0) securityConfig.dailyLimit = newDaily;

            saveConfig();
            updateStatsDisplay();
            alert('‚úÖ Limites mises √† jour !');
        }

        // V√©rifier les limites avant transaction
        function checkLimits(amount) {
            checkDailyReset();

            if (amount > securityConfig.maxPerTransaction) {
                throw new Error(`Montant sup√©rieur √† la limite par transaction (${securityConfig.maxPerTransaction} BNB)`);
            }

            if (securityConfig.dailySpent + amount > securityConfig.dailyLimit) {
                throw new Error(`Limite quotidienne d√©pass√©e. Restant: ${(securityConfig.dailyLimit - securityConfig.dailySpent).toFixed(4)} BNB`);
            }

            return true;
        }

        // V√©rifier la liste blanche
        function isWhitelisted(address) {
            return securityConfig.whitelist.some(addr => addr.toLowerCase() === address.toLowerCase());
        }

        // Ajouter √† la liste blanche
        function addToWhitelist() {
            const address = document.getElementById('newWhitelistAddress').value.trim();
            if (address && ethers.isAddress(address)) {
                if (!isWhitelisted(address)) {
                    securityConfig.whitelist.push(address);
                    saveConfig();
                    updateWhitelistDisplay();
                    document.getElementById('newWhitelistAddress').value = '';
                    alert('‚úÖ Adresse ajout√©e √† la liste blanche !');
                } else {
                    alert('‚ÑπÔ∏è Cette adresse est d√©j√† dans la liste blanche.');
                }
            } else {
                alert('‚ùå Adresse invalide.');
            }
        }

        // Retirer de la liste blanche
        function removeFromWhitelist(address) {
            securityConfig.whitelist = securityConfig.whitelist.filter(addr => addr !== address);
            saveConfig();
            updateWhitelistDisplay();
        }

        // Afficher la liste blanche
        function updateWhitelistDisplay() {
            const div = document.getElementById('whitelistDisplay');
            div.innerHTML = '';
            securityConfig.whitelist.forEach(address => {
                const item = document.createElement('div');
                item.className = 'whitelist-item';
                item.innerHTML = `
                    <span>${address}</span>
                    <button onclick="removeFromWhitelist('${address}')" class="danger">Retirer</button>
                `;
                div.appendChild(item);
            });
        }

        // Ex√©cuter un trade
        async function executeTrade() {
            if (securityConfig.emergencyStop) {
                alert('üö® ARR√äT D\'URGENCE ACTIF ! Trading d√©sactiv√©.');
                return;
            }

            const recipient = document.getElementById('recipientAddress').value.trim();
            const amount = parseFloat(document.getElementById('sendAmount').value);
            const messageDiv = document.getElementById('tradeMessage');

            if (!recipient || !amount) {
                messageDiv.innerHTML = '<div class="error">Veuillez remplir tous les champs.</div>';
                return;
            }

            if (!isWhitelisted(recipient)) {
                messageDiv.innerHTML = '<div class="error">‚ùå Adresse non autoris√©e (pas dans la liste blanche).</div>';
                return;
            }

            try {
                checkLimits(amount);

                const tx = await wallet.sendTransaction({
                    to: recipient,
                    value: ethers.parseEther(amount.toString())
                });

                messageDiv.innerHTML = '<div class="success-msg">‚è≥ Transaction envoy√©e ! Hash: ' + tx.hash.substring(0, 20) + '...</div>';

                await tx.wait();

                // Mettre √† jour les stats
                securityConfig.dailySpent += amount;
                securityConfig.transactionLogs.unshift({
                    time: new Date().toLocaleString(),
                    amount: amount,
                    to: recipient,
                    hash: tx.hash,
                    status: 'success'
                });
                
                if (securityConfig.transactionLogs.length > 20) {
                    securityConfig.transactionLogs = securityConfig.transactionLogs.slice(0, 20);
                }

                saveConfig();
                updateStatsDisplay();
                updateLogsDisplay();
                refreshBalance();

                messageDiv.innerHTML = '<div class="success-msg">‚úÖ Transaction confirm√©e !</div>';
                document.getElementById('recipientAddress').value = '';
                document.getElementById('sendAmount').value = '';

            } catch (error) {
                messageDiv.innerHTML = '<div class="error">‚ùå ' + error.message + '</div>';
                
                securityConfig.transactionLogs.unshift({
                    time: new Date().toLocaleString(),
                    amount: amount,
                    to: recipient,
                    status: 'failed',
                    error: error.message
                });
                saveConfig();
                updateLogsDisplay();
            }
        }

        // Afficher les logs
        function updateLogsDisplay() {
            const div = document.getElementById('transactionLogs');
            div.innerHTML = '';
            
            if (securityConfig.transactionLogs.length === 0) {
                div.innerHTML = '<p style="text-align: center; color: #999;">Aucune transaction</p>';
                return;
            }

            securityConfig.transactionLogs.forEach(log => {
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                const statusColor = log.status === 'success' ? '#28a745' : '#dc3545';
                entry.innerHTML = `
                    <div class="log-time">${log.time}</div>
                    <div><strong style="color: ${statusColor}">${log.status === 'success' ? '‚úÖ' : '‚ùå'} ${log.amount} BNB ‚Üí ${log.to.substring(0, 10)}...</strong></div>
                    ${log.hash ? `<div style="font-size: 11px; color: #666;">Hash: ${log.hash.substring(0, 20)}...</div>` : ''}
                    ${log.error ? `<div style="font-size: 11px; color: #dc3545;">Erreur: ${log.error}</div>` : ''}
                `;
                div.appendChild(entry);
            });
        }

        // Arr√™t d'urgence
        function toggleEmergencyStop() {
            securityConfig.emergencyStop = !securityConfig.emergencyStop;
            saveConfig();
            updateBotStatus();
            
            if (securityConfig.emergencyStop) {
                alert('üö® ARR√äT D\'URGENCE ACTIV√â ! Toutes les transactions sont bloqu√©es.');
            } else {
                alert('‚úÖ Bot r√©activ√©. Les transactions sont √† nouveau autoris√©es.');
            }
        }

        // Mettre √† jour le statut du bot
        function updateBotStatus() {
            const badge = document.getElementById('botStatus');
            const btn = document.getElementById('emergencyBtn');
            const tradeBtn = document.getElementById('tradeBtn');
            
            if (securityConfig.emergencyStop) {
                badge.textContent = 'Bot Arr√™t√©';
                badge.className = 'status-badge status-stopped';
                btn.textContent = 'R√âACTIVER LE BOT';
                tradeBtn.disabled = true;
            } else {
                badge.textContent = 'Bot Actif';
                badge.className = 'status-badge status-active';
                btn.textContent = 'ARR√äT D\'URGENCE';
                tradeBtn.disabled = false;
            }
        }

        // D√©connexion
        function logout() {
            wallet = null;
            document.getElementById('mainScreen').classList.add('hidden');
            showLoginScreen();
        }

        // Afficher l'√©cran de connexion
        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('createScreen').classList.add('hidden');
            document.getElementById('loginPassword').value = '';
        }

        // Afficher l'√©cran de cr√©ation
        function showCreateScreen() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('createScreen').classList.remove('hidden');
        }

        // V√©rifier si un wallet existe au d√©marrage
        window.onload = function() {
            const hasWallet = localStorage.getItem('encryptedWallet');
            if (!hasWallet) {
                showCreateScreen();
            }
        };
    </script>
</body>
</html>
